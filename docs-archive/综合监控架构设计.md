# Claude 桌面宠物 - 综合状态监控系统

**版本**: v2.0
**更新**: 2026-02-04

---

## 一、概述

采用多种监控方式，综合判断 Claude Code 状态，提高准确性。

---

## 二、监控源架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      状态融合引擎                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│   │ 进程监控器   │  │ 文件监控器   │  │ 窗口监控器   │           │
│   │ ProcessMonitor│  │ FileMonitor │  │ WindowMonitor│           │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘           │
│          │                │                │                    │
│          ▼                ▼                ▼                    │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│   │ CPU/内存     │  │ 文件变更     │  │ 标题分析     │           │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘           │
│          │                │                │                    │
│          └────────────────┼────────────────┘                    │
│                           │                                 │
│                           ▼                                 │
│                  ┌─────────────────┐                        │
│                  │   StatusFusion  │                        │
│                  │   (综合判断)    │                        │
│                  └────────┬────────┘                        │
│                           │                                 │
│                           ▼                                 │
│                  ┌─────────────────┐                        │
│                  │  最终状态输出    │                        │
│                  └─────────────────┘                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、监控源详情

### 3.1 进程监控（ProcessMonitor）

| 指标 | 来源 | 权重 |
|------|------|------|
| CPU 占用 | psutil | 高 |
| 内存占用 | psutil | 中 |
| 进程数量 | psutil | 低 |

**状态映射**：

| CPU 范围 | 推断状态 |
|----------|----------|
| < 0.5% | idle |
| 0.5% - 3% | running |
| 3% - 15% | thinking |
| 15% - 50% | working |
| > 50% | busy |

---

### 3.2 文件监控（FileMonitor）

| 指标 | 来源 | 权重 |
|------|------|------|
| 变更频率 | watchdog | 中 |
| 变更类型 | watchdog | 中 |

**状态映射**：

| 变更频率 | 推断状态 |
|----------|----------|
| 无变更 | idle/running |
| 低频 (<3/秒) | thinking |
| 中频 (3-10/秒) | working |
| 高频 (>10/秒) | busy |

---

### 3.3 窗口监控（WindowMonitor）

| 指标 | 来源 | 权重 |
|------|------|------|
| 窗口标题 | pygetwindow | 高 |
| 窗口文本 | pywinauto | 高 |

**状态映射**（关键词匹配）：

| 关键词 | 推断状态 |
|--------|----------|
| "Thinking" | thinking |
| "Reading" | reading |
| "Edit", "Write" | writing |
| "Bash", "Execute" | executing |
| "Done", "Complete" | done |
| "Error", "Failed" | error |

---

## 四、状态定义

| 状态 | 说明 | 优先级 |
|------|------|--------|
| not_running | 未运行 | 0 |
| idle | 待机 | 1 |
| running | 运行中 | 2 |
| reading | 读取文件 | 3 |
| writing | 写入文件 | 4 |
| thinking | 思考 | 5 |
| executing | 执行命令 | 6 |
| working | 工作/忙碌 | 7 |
| error | 错误 | 8 |
| done | 完成 | 9 |

---

## 五、融合算法

### 5.1 加权投票

```
最终状态 = argmax(Σ (各源权重 × 状态置信度))

示例：
  进程监控: running (置信度 0.8, 权重 0.5)
  文件监控: working (置信度 0.6, 权重 0.3)
  窗口监控: thinking (置信度 0.9, 权重 0.2)
  
  running: 0.8 × 0.5 = 0.40
  working: 0.6 × 0.3 = 0.18
  thinking: 0.9 × 0.2 = 0.18
  
  最终状态: running
```

### 5.2 优先级覆盖

某些状态具有更高优先级：

```
error > done > executing > writing > reading > thinking > working > running > idle > not_running
```

---

## 六、实现状态

| 模块 | 状态 |
|------|------|
| ProcessMonitor | ✅ 已实现 |
| FileMonitor | ✅ 已实现 |
| WindowMonitor | ⏳ 待开发 |
| StatusFusion | ⏳ 待开发 |

---

## 七、代码结构

```
src/
├── monitor/
│   ├── __init__.py
│   ├── base.py              # 监控基类
│   ├── process_monitor.py    # 进程监控 ☐
│   ├── file_monitor.py      # 文件监控 ☐
│   ├── window_monitor.py    # 窗口监控 ☐
│   └── status_fusion.py     # 状态融合 ☐
```

---

## 八、下一步

1. 创建 src/monitor/ 目录
2. 实现 WindowMonitor
3. 实现 StatusFusion
4. 更新 GUI 使用综合状态
