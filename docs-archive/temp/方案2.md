# Claude Code 桌面小宠物 - 实现方案

## 一、技术选型：Python + PyQt5

### 为什么选这个组合？

| 考量 | 为什么推荐 Python + PyQt |
|------|--------------------------|
| **学习成本** | Python 是最友好的入门语言，PyQt 文档丰富 |
| **AI 协作** | GPT/Claude 对 Python 支持最好，直接复制粘贴就能跑 |
| **桌面应用** | PyQt 是成熟的 UI 框架，支持 GIF 播放 |
| **跨平台** | Windows/Mac/Linux 都能用 |
| **生态完善** | 监听进程、窗口、有现成库 |

---

## 二、方案架构

```
┌─────────────────────────────────────────────────────────────┐
│                    桌面小宠物 App                            │
│  ┌────────────┐    ┌─────────────┐    ┌─────────────────┐ │
│  │  GIF 播放  │    │  状态识别器  │    │  窗口绑定器      │ │
│  │  组件       │    │  (文本匹配)   │    │  (选窗口/进程)   │ │
│  └────────────┘    └─────────────┘    └─────────────────┘ │
│         │                  │                  │            │
│         ▼                  ▼                  ▼            │
│   像素猫动画 GIF      分析输出文本      获取终端内容        │
│   对应不同状态      →  判断当前状态                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  Claude Code 终端 │
                    │  (已运行的会话)   │
                    └──────────────────┘
```

---

## 三、核心功能拆解

### 1️⃣ 窗口绑定 - 最简单方案

启动时弹出窗口让用户选择：

```
┌────────────────────────────────────┐
│  请选择 Claude Code 窗口           │
│  ┌──────────────────────────────┐  │
│  │ ☐ C:\Windows\System32\cmd.exe │  │
│  │ ☐ Terminal - Claude-Code     │  │
│  │ ☑ PowerShell (Claude Code)   │  │
│  └──────────────────────────────┘  │
│                                     │
│         [ 绑定并开始 ]              │
└────────────────────────────────────┘
```

**实现方式**：用 `pygetwindow` 库枚举所有窗口，让用户点选

---

### 2️⃣ 获取终端内容 - 两种方案选一个

#### 方案 A: 直接读取窗口文本（推荐，最简单）
```python
# 用 pywinauto 读取窗口内容
text = app.window_text()  # 获取终端里所有文本
```

✅ **优点**：代码5行就能搞定
❌ **缺点**：某些终端可能读不到

#### 方案 B: 让用户复制粘贴（兜底方案）
启动时提示用户把 Claude Code 设置为"输出到文件"或"复制到剪贴板"

---

### 3️⃣ 状态识别 - 简单关键词匹配

不需要复杂解析，就靠正则匹配：

```python
状态映射表：
"Thinking"    → thinking.gif
"Read:"       → reading.gif
"Edit:"       → coding.gif
"Bash:"       → typing.gif
"Done" / "✓"  → celebrate.gif
"Error"       → sad.gif
没有变化超时   → idle.gif
```

---

### 4️⃣ GIF 播放

用 PyQt 的 `QMovie` 组件：
```python
movie = QMovie("thinking.gif")
label.setMovie(movie)
movie.start()
```

---

## 四、Claude Code 状态全分析

### 状态流转图

```
用户输入 ──► 思考 ──► 执行工具 ──► 思考 ──► 执行工具 ──► ... ──► 完成/等待
                                    │
                                    ▼
                                 错误状态
```

---

### 详细状态分类

| 状态 | 触发场景 | 输出特征 | GIF 映射 |
|------|---------|---------|---------|
| **Idle / Waiting** | 等待用户输入 | `>` 或 `$` 提示符 | idle.gif (发呆/喝咖啡) |
| **Thinking** | Claude 推理 | `Thinking about...` 或思考动画 | thinking.gif (走向白板沉思) |
| **Reading** | 读取文件 | `Read: file_path` | reading.gif (看书) |
| **Writing** | 写入文件 | `Write: file_path` | coding.gif (敲键盘) |
| **Editing** | 修改文件 | `Edit: file_path` | coding.gif (敲键盘+高亮) |
| **Bash** | 执行命令 | `Bash: command ...` | typing.gif (敲终端) |
| **Grep/Glob** | 搜索代码 | `Grep: pattern ...` | searching.gif (翻找文件) |
| **AskUserQuestion** | 等待用户决定 | `?` 提示 + 选项 | confused.gif (抬头看用户) |
| **Task** | 启动子 agent | `Task tool launched` | calling.gif (叫同事) |
| **Done/Success** | 任务完成 | `[Completed]` 或 ✓ | celebrate.gif (起身庆祝) |
| **Error** | 出错 | `Error:` 或红色文字 | sad.gif (摇头/叹气) |

---

### 有意思的状态组合对应场景

| 工具序列 | 场景 | 动画建议 |
|---------|------|---------|
| `Grep → Read × N → Task` | "我需要更多上下文" | calling.gif (叫个同事来帮忙) |
| `Read → Edit × N → Bash` | "改完代码跑一下" | typing.gif (敲完按回车，期待表情) |
| `Grep → Grep → Grep` | 找不到东西 | confused.gif (翻箱倒柜，挠头) |
| `Task → Task → Task` | 并行处理 | busy.gif (多个分头行动) |
| `Read × N` | 深入分析 | analyzing.gif (拿放大镜看代码) |

---

## 五、动画素材来源

| 来源 | 说明 |
|------|------|
| **GIPHY** | 搜索 "pixel cat coding" |
| **Epic Pixels** | 很多免费像素动画 |
| **OpenGameArt** | 游戏素材网站 |
| **AI 生成** | 让 AI 帮你生成 GIF |

---

## 六、技术栈总结

| 需要安装的库 | 用途 |
|-------------|------|
| `PyQt5` | 桌面 UI |
| `pygetwindow` | 获取窗口列表 |
| `pywinauto` | 读取窗口内容 |
| `re` (内置) | 文本匹配 |

### 一行安装命令：
```bash
pip install PyQt5 pygetwindow pywinauto
```

---

## 七、开发步骤（按优先级）

### MVP 版本（先跑起来）
1. 创建 PyQt 窗口，显示一个 GIF
2. 手动绑定按键测试切换不同的 GIF
3. 确认动画流畅

### v1.0 版本
4. 添加窗口选择功能
5. 读取终端文本
6. 简单关键词匹配 → 切换 GIF

### v2.0 版本（如需要）
7. 添加设置界面（自选窗口、调整大小）
8. 更多状态和动画
9. 托盘图标最小化

---

## 八、边界情况处理

| 情况 | 如何识别 | 处理策略 |
|------|---------|---------|
| 同时有多个输出流 (如后台 Task) | 监听多个进程 | 触发 "calling" 动画表示有多任务 |
| 用户中断 | Ctrl+C 信号 | 动画突然停住，困惑表情 |
| 待机太久 | 长时间无输出 | 切换到 idle.gif (打瞌睡) |
| 计划模式阶段 | "Plan Mode" 提示 | planning.gif (画规划图) |

---

## 九、开发建议

### Phase 1: 先做个 Demo（1-2小时）
- 创建一个能播放 GIF 的窗口
- 手动按 1/2/3 键切换不同 GIF
- 确认技术和素材都 OK

### Phase 2: 集成状态识别（半天）
- 添加窗口选择功能
- 实现简单文本匹配

### Phase 3: 完善体验
- 优化状态判断逻辑
- 找更多好玩的 GIF

**优点**: 每一步都可以独立验证，有问题随时可以调整。
