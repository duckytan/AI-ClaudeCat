# AI-ClaudeCat 状态详解

## 📊 8 种状态说明

### 1. **UNKNOWN** (未知)
- **含义**: 无法判断当前状态
- **触发**: 初始化时，或遇到未识别的事件
- **置信度**: 通常 < 50%

### 2. **IDLE** (空闲)
- **含义**: AI 空闲，等待用户输入
- **触发**: 
  - 会话刚开始（`file-history-snapshot` 事件）
  - AI 完成回复后
  - 用户还没发送新消息
- **置信度**: 90%
- **示例**: 你打开 Claude Code，还没输入任何内容

### 3. **RUNNING** (运行中)
- **含义**: AI 接收到用户输入，开始处理
- **触发**: 检测到 `user` 事件（用户发送消息）
- **置信度**: 95%
- **示例**: 你在 Claude Code 输入框按下回车

### 4. **THINKING** (思考中)
- **含义**: AI 正在内部推理、规划
- **触发**: 检测到 `thinking` 块
- **置信度**: 95%
- **示例**: AI 在思考如何回答你的问题

### 5. **WORKING** (工作中)
- **含义**: AI 正在执行操作（读写文件、搜索等）
- **触发**: 检测到工具调用
  - `Read` - 读取文件
  - `Write` - 写入文件
  - `Edit` - 编辑文件
  - `Grep` - 搜索代码
  - `WebFetch` - 网络请求
- **置信度**: 80-90%
- **示例**: AI 正在读取你的代码文件

### 6. **EXECUTING** (执行中)
- **含义**: AI 正在执行命令
- **触发**: 检测到 `Bash` 工具调用
- **置信度**: 95%
- **示例**: AI 运行 `npm install` 或 `python test.py`

### 7. **ERROR** (错误)
- **含义**: 遇到错误（API 失败、工具执行失败）
- **触发**: 检测到 `system` 事件 + `api_error` 子类型
- **置信度**: 95%
- **示例**: Claude API 返回 502/429 错误

### 8. **STOPPED** (停止)
- **含义**: 进程已关闭
- **触发**: 插件停止时
- **置信度**: 100%

---

## 🔍 你的输出详细解析

### 输出格式说明

```
[HH:MM:SS] [STATUS] source (confidence%)
```

- **HH:MM:SS**: 时间戳（时:分:秒）
- **STATUS**: 状态（IDLE/RUNNING/THINKING/WORKING/EXECUTING/ERROR）
- **source**: 来源插件（claude_log）
- **confidence%**: 置信度百分比

### 场景重现

```
[14:23:15] [IDLE] claude_log (90%)
[14:23:18] [RUNNING] claude_log (95%)
[14:23:19] [ERROR] claude_log (95%)
```

**实际发生了什么**：

#### 步骤 1: IDLE (空闲)
```jsonl
{"type":"file-history-snapshot", ...}
```
- **事件**: 会话开始或新一轮对话准备就绪
- **AI 状态**: 等待你输入
- **置信度**: 90%（因为只是推断，不是明确信号）

#### 步骤 2: RUNNING (运行中)
```jsonl
{"type":"user", "message":{"role":"user","content":[{"type":"text","text":"..."}]}}
```
- **事件**: 你发送了一条消息
- **AI 状态**: 接收到输入，开始处理
- **置信度**: 95%（非常确定）

#### 步骤 3: ERROR (错误)
```jsonl
{"type":"system","subtype":"api_error","error":{"status":502,"error":{"code":"channel_error",...}}}
```
- **事件**: Claude API 返回错误
  - `502` = 服务器错误（上游错误）
  - `429` = 速率限制（RPM limit exceeded）
- **AI 状态**: 调用失败，需要重试
- **置信度**: 95%（明确的错误信号）

---

## 🎯 完整对话流程示例

### 正常流程（无错误）

```
用户: "帮我写一个 Python 函数"

[14:23:10] [IDLE] (90%)          → 等待输入
[14:23:15] [RUNNING] (95%)       → 接收到消息
[14:23:16] [THINKING] (95%)      → AI 思考方案
[14:23:20] [WORKING] (90%)       → 创建文件
[14:23:22] [WORKING] (90%)       → 写入代码
[14:23:25] [IDLE] (90%)          → 完成，等待下一条
```

### 有错误的流程（你的情况）

```
用户: "我已经在ClaudeCode里发送消息开始聊天了"

[14:23:10] [IDLE] (90%)          → 等待输入
[14:23:15] [RUNNING] (95%)       → 接收到消息
[14:23:16] [ERROR] (95%)         → API 错误（502）
[14:23:18] [ERROR] (95%)         → 重试失败（502）
[14:23:20] [ERROR] (95%)         → 再次失败（429 速率限制）
[14:23:25] [THINKING] (95%)      → 最终成功，开始思考
[14:23:28] [WORKING] (90%)       → 开始工作
[14:23:35] [IDLE] (90%)          → 完成回复
```

---

## 🛠️ 工具调用映射表

| 工具名称 | 触发状态 | 置信度 | 示例 |
|---------|---------|--------|------|
| `thinking` | THINKING | 95% | AI 内部推理 |
| `Read` | WORKING | 90% | 读取文件内容 |
| `Write` | WORKING | 90% | 创建/覆盖文件 |
| `Edit` | WORKING | 90% | 修改文件 |
| `Bash` | EXECUTING | 95% | 执行命令 |
| `Grep` | WORKING | 85% | 搜索代码 |
| `Glob` | WORKING | 85% | 文件匹配 |
| `WebFetch` | WORKING | 90% | 网络请求 |
| `Task` | WORKING | 85% | 派生子 Agent |

---

## 💡 为什么会有多个相同状态？

### 原因 1: 重复事件
Claude Code 写入日志时，同一个状态可能触发多次：

```jsonl
{"type":"file-history-snapshot", ...}  → IDLE
{"type":"user", ...}                   → RUNNING
{"type":"system","subtype":"api_error"} → ERROR
{"type":"system","subtype":"api_error"} → ERROR  (重试)
{"type":"system","subtype":"api_error"} → ERROR  (再次重试)
```

### 原因 2: 状态去重逻辑
代码中有这样的逻辑：

```python
async def _update_status(self, status: Status, confidence: float, details: Dict):
    if status == self.last_status:
        return  # 状态未变化，不重复输出
```

但如果置信度或细节不同，还是会输出。

---

## 🎨 如何理解输出

### 建议的阅读方式

1. **关注状态变化** - 从 IDLE → RUNNING → WORKING 的转换
2. **忽略重复** - 连续的相同状态可以跳过
3. **注意 ERROR** - 表示 API 调用失败，正在重试
4. **最后的状态** - 最终 AI 进入了什么状态

### 简化输出建议

如果你觉得太啰嗦，可以修改配置只显示状态变化：

```json
{
  "adapters": {
    "stdout": {
      "enabled": true,
      "format": "minimal",  // 只显示状态变化
      "show_duplicates": false  // 隐藏重复状态
    }
  }
}
```

---

## 🔧 实时调试

如果你想看更详细的原始事件，可以运行：

```bash
# 查看最后 10 条日志
python -c "
import json
with open(r'C:\Users\ducky\.claude\projects\D--AI-Project-AI-ClaudeCat\0fa00935-20ad-43a0-a379-27d9406c7f04.jsonl', 'r', encoding='utf-8') as f:
    lines = f.readlines()
    for line in lines[-10:]:
        event = json.loads(line)
        print(f\"Type: {event.get('type')}, Subtype: {event.get('subtype', 'N/A')}\")
"
```

---

## 📝 总结

你看到的输出：
```
[14:23:15] [IDLE] claude_log (90%)          # 会话就绪
[14:23:18] [RUNNING] claude_log (95%)       # 你发送了消息
[14:23:19] [ERROR] claude_log (95%)         # API 错误（502/429）
```

**翻译成人话**：
1. **14:23:15** - AI 在等你说话
2. **14:23:18** - 你说了句话（间隔 3 秒）
3. **14:23:19** - Claude API 炸了（1 秒后出错）
4. 然后重试几次，最终成功回复

这是完全正常的！Claude API 偶尔会有网络问题或速率限制，系统会自动重试。

**需要担心吗？** ❌ 不需要，这是正常现象。
