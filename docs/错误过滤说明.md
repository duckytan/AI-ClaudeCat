# 错误过滤说明

## 概述

AI-ClaudeCat v4.0 自动过滤无关紧要的临时性错误，只显示真正需要用户关注的重大错误。

---

## 错误分类

### 🟢 自动忽略（临时性错误）

这些错误会自动重试，无需用户干预：

| 错误类型 | 说明 | HTTP 状态码 |
|---------|------|------------|
| `overloaded_error` | 服务器过载 | 502 |
| `rate_limit_error` | 速率限制 | 429 |
| `timeout_error` | 请求超时 | 504 |
| `connection_error` | 网络连接失败 | - |
| `service_unavailable` | 服务暂时不可用 | 503 |

**行为**：
- ✅ 只打印警告到控制台
- ✅ 不触发 `[ERROR]` 状态
- ✅ 保持之前的状态（`THINKING`/`WORKING`）
- ✅ Claude Code 会自动重试

**示例输出**：
```
[claude_log] [WARNING] overloaded_error: Service is temporarily overloaded (已自动忽略)
```

---

### 🔴 重大错误（需要关注）

这些错误需要用户处理：

| 错误类型 | 说明 | 解决方法 |
|---------|------|---------|
| `invalid_request_error` | 请求格式错误 | 检查代码或配置 |
| `authentication_error` | 认证失败 | 检查 API 密钥 |
| `permission_error` | 权限不足 | 检查账户权限 |
| `not_found_error` | 资源不存在 | 检查请求路径 |
| `api_error` | API 内部错误 | 联系技术支持 |

**行为**：
- 🚨 触发 `[ERROR]` 状态
- 🚨 在界面显示错误
- 🚨 需要用户处理

**示例输出**：
```
[ERROR] claude_log (95%) - authentication_error: Invalid API key
```

---

## 配置选项

### 默认配置（推荐）

```json
{
  "plugins": {
    "claude_log": {
      "show_all_errors": false  // 默认：只显示重大错误
    }
  }
}
```

### 显示所有错误（调试模式）

如果你需要查看所有错误（包括临时性错误）：

```json
{
  "plugins": {
    "claude_log": {
      "show_all_errors": true  // 调试：显示所有错误
    }
  }
}
```

---

## 实际案例

### 案例 1：服务器过载（自动忽略）

**场景**：Claude API 服务器繁忙

**日志文件**：
```json
{
  "type": "system",
  "subtype": "api_error",
  "error": {
    "error": {
      "type": "overloaded_error",
      "message": "Service is temporarily overloaded"
    }
  }
}
```

**AI-ClaudeCat 行为**：
```
[14:23:15] [claude_log] [WARNING] overloaded_error: Service is temporarily overloaded (已自动忽略)
[14:23:15] [WORKING] claude_log (90%)  // 保持 WORKING 状态
```

**结果**：
- ✅ 用户看不到 `[ERROR]`
- ✅ Claude Code 自动重试
- ✅ 几秒后恢复正常

---

### 案例 2：认证失败（显示错误）

**场景**：API 密钥过期

**日志文件**：
```json
{
  "type": "system",
  "subtype": "api_error",
  "error": {
    "error": {
      "type": "authentication_error",
      "message": "Invalid API key"
    }
  }
}
```

**AI-ClaudeCat 行为**：
```
[14:25:30] [ERROR] claude_log (95%) - authentication_error: Invalid API key
```

**结果**：
- 🚨 用户看到 `[ERROR]`
- 🚨 需要检查 Claude Code 配置
- 🚨 需要更新 API 密钥

---

## 状态转换

### 默认模式（`show_all_errors: false`）

```
[14:23:10] [THINKING] → 502 错误 → [WARNING] (控制台) → [THINKING] (保持)
                                                     ↓
                                              自动重试 → [WORKING] ✅
```

### 调试模式（`show_all_errors: true`）

```
[14:23:10] [THINKING] → 502 错误 → [14:23:11] [ERROR] claude_log (95%) 🚨
                                          ↓
                                    自动重试 → [14:23:15] [WORKING]
```

---

## 常见问题

### Q: 为什么 502/429 不算错误？

**A**: 这些是临时性的服务器问题，Claude Code 会自动重试：
- **502**：服务器过载，通常 1-5 秒后恢复
- **429**：速率限制，等待后自动重试
- **504**：超时，通常是网络波动

这些错误不需要用户干预，显示 `[ERROR]` 反而会让人紧张。

---

### Q: 如何查看被忽略的错误？

**A**: 两种方法：

1. **查看控制台**（推荐）
   ```
   [claude_log] [WARNING] overloaded_error: Service is temporarily overloaded (已自动忽略)
   ```

2. **启用调试模式**
   ```json
   {
     "plugins": {
       "claude_log": {
         "show_all_errors": true
       }
     }
   }
   ```

---

### Q: 错误过滤会影响功能吗？

**A**: 不会：
- ✅ 所有错误仍然被**记录**（日志文件、控制台）
- ✅ 只是不触发 `[ERROR]` **状态**
- ✅ 重大错误仍然会**显示**

---

## 总结

| 类型 | 显示方式 | 触发 ERROR 状态 | 需要处理 |
|-----|---------|----------------|---------|
| 临时性错误 | 控制台 WARNING | ❌ | ❌ |
| 重大错误 | 界面 ERROR | ✅ | ✅ |

**设计理念**：
> "不要用无关紧要的错误吓唬用户，只显示真正需要关注的问题。"

---

**最后更新**: 2026-02-06  
**版本**: v4.0.0
