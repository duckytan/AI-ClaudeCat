# AI-ClaudeCat v4.0 重构任务清单

**目标**: 采用 PixelHQ-bridge 的日志监控方案，替代当前不可靠的系统 API 方式  
**预计工作量**: 4-6 天  
**状态**: 🔴 未开始

---

## 第一阶段：核心重构（v4.0-alpha）⏱️ 2-3 天

### Day 1: 核心插件开发 ✅ 0/7

- [ ] **1.1** 创建 `src/plugins/claude_log.py` 文件
  - [ ] 基础类结构（`ClaudeLogPlugin`）
  - [ ] `__init__` 方法（初始化）
  - [ ] `_find_claude_projects_dir()` 方法（查找目录）
  - [ ] `check_available()` 方法（可用性检查）

- [ ] **1.2** 实现文件监控（watchdog）
  - [ ] 安装依赖：`pip install watchdog`
  - [ ] `_start_file_watcher()` 方法
  - [ ] `LogFileHandler` 类（事件处理器）
  - [ ] `_scan_existing_files()` 方法（扫描现有文件）

- [ ] **1.3** 实现增量读取
  - [ ] `file_positions: Dict[str, int]` 字段（位置记录）
  - [ ] `_handle_file_change()` 方法（文件变化处理）
  - [ ] `_read_new_lines()` 方法（增量读取）

- [ ] **1.4** 实现 JSONL 解析
  - [ ] `_handle_new_line()` 方法（解析单行）
  - [ ] `_handle_assistant_message()` 方法（处理 AI 消息）
  - [ ] `_handle_user_message()` 方法（处理用户消息）

- [ ] **1.5** 实现状态推断
  - [ ] `_tool_to_status()` 方法（工具 → 状态映射）
  - [ ] `_update_status()` 方法（更新状态）
  - [ ] 状态变化检测（只在变化时发送事件）

- [ ] **1.6** 实现 Token 统计
  - [ ] `token_stats: Dict` 字段
  - [ ] `_update_tokens()` 方法

- [ ] **1.7** 单元测试
  - [ ] 创建 `tests/test_claude_log.py`
  - [ ] 测试 JSONL 解析
  - [ ] 测试状态推断
  - [ ] 测试增量读取

---

### Day 2: 中间件增强 ✅ 0/6

- [ ] **2.1** 创建隐私过滤器
  - [ ] 创建 `src/middleware/privacy.py`
  - [ ] `PrivacyFilter` 类
  - [ ] `filter_event()` 方法（过滤事件）
  - [ ] `_filter_dict()` 方法（过滤字典）
  - [ ] 白名单配置

- [ ] **2.2** 创建 Token 统计器
  - [ ] 创建 `src/middleware/token_stats.py`
  - [ ] `TokenStats` 类
  - [ ] `update()` 方法（更新统计）
  - [ ] `get_summary()` 方法（获取摘要）

- [ ] **2.3** 简化状态融合
  - [ ] 更新 `src/middleware/fusion.py`
  - [ ] 单插件模式（简化优先级投票）
  - [ ] 直接使用 `ClaudeLogPlugin` 的高优先级事件

- [ ] **2.4** 更新中间件核心
  - [ ] 更新 `src/middleware/core.py`
  - [ ] 集成 `PrivacyFilter`
  - [ ] 集成 `TokenStats`
  - [ ] 更新事件处理流程

- [ ] **2.5** 更新配置系统
  - [ ] 更新 `config.json`
  - [ ] 添加 `claude` 配置项
  - [ ] 添加 `privacy_filter` 配置项
  - [ ] 添加 `token_stats` 配置项

- [ ] **2.6** 测试中间件
  - [ ] 测试隐私过滤
  - [ ] 测试 Token 统计
  - [ ] 测试事件流

---

### Day 3: 输出和测试 ✅ 0/5

- [ ] **3.1** 创建历史存储适配器
  - [ ] 创建 `src/adapters/history_adapter.py`
  - [ ] `HistoryAdapter` 类
  - [ ] `_init_db()` 方法（初始化 SQLite）
  - [ ] `send()` 方法（保存事件）
  - [ ] `query()` 方法（查询历史）

- [ ] **3.2** 更新主程序
  - [ ] 更新 `main.py`
  - [ ] 使用 `create_claude_log_plugin()`
  - [ ] 初始化 `PrivacyFilter`
  - [ ] 初始化 `TokenStats`
  - [ ] 添加 Token 统计输出

- [ ] **3.3** 集成测试
  - [ ] 运行 Claude Code
  - [ ] 验证文件监控
  - [ ] 验证状态检测
  - [ ] 验证事件输出（WebSocket/HTTP/Stdout）
  - [ ] 验证历史存储

- [ ] **3.4** 性能测试
  - [ ] 测试 CPU 占用
  - [ ] 测试内存占用
  - [ ] 测试响应延迟
  - [ ] 优化性能瓶颈

- [ ] **3.5** 创建测试脚本
  - [ ] 创建 `test_v4.py`
  - [ ] 模拟 JSONL 日志写入
  - [ ] 验证状态推断
  - [ ] 验证隐私过滤

---

## 第二阶段：功能增强（v4.0-beta）⏱️ 1-2 天

### Day 4: Agent 追踪 ✅ 0/4

- [ ] **4.1** 实现 subagent 文件关联
  - [ ] 监控 `subagents/*.jsonl` 文件
  - [ ] `_extract_session_id()` 方法（支持 subagent 路径）
  - [ ] `_is_subagent_file()` 方法

- [ ] **4.2** 实现 Task 工具追踪
  - [ ] `pending_tasks: Set[str]` 字段
  - [ ] `pending_spawn_queue: List[str]` 字段（FIFO）
  - [ ] 检测 Task 工具调用

- [ ] **4.3** 实现 Agent 关联
  - [ ] `agent_id_map: Dict[str, str]` 字段
  - [ ] `_correlate_agent_file()` 方法
  - [ ] FIFO 队列匹配

- [ ] **4.4** 实现 Agent 完成事件
  - [ ] 检测 tool_result（Task 工具）
  - [ ] 发送 Agent completed 事件
  - [ ] 清理 Agent 映射

---

### Day 5: 查询 API ✅ 0/3

- [ ] **5.1** HTTP 历史查询接口
  - [ ] `GET /api/history` 路由
  - [ ] 参数：`start_time`, `end_time`, `limit`
  - [ ] 返回：JSON 格式事件列表

- [ ] **5.2** Token 统计接口
  - [ ] `GET /api/stats/tokens` 路由
  - [ ] 返回：Token 使用摘要
  - [ ] 包含：总量、平均值、缓存命中率

- [ ] **5.3** 实时状态接口
  - [ ] `GET /api/status` 路由
  - [ ] 返回：当前状态
  - [ ] 包含：status, confidence, details

---

## 第三阶段：清理和发布（v4.0-stable）⏱️ 1 天

### Day 6: 代码清理和文档 ✅ 0/5

- [ ] **6.1** 删除/归档旧插件
  - [ ] 移动 `src/apps/claude_code.py` → `src/apps/_deprecated/`
  - [ ] 移动 `src/plugins/process.py` → `src/plugins/_deprecated/`
  - [ ] 移动 `src/plugins/window.py` → `src/plugins/_deprecated/`
  - [ ] **✅ 保留** `src/utils/window_detector.py`（独立工具，暂不实装）
    - 用途：未来自动进程发现、自动绑定进程
    - 用途：多实例监控（同时追踪多个 AI 工具窗口）
    - 状态：独立模块，不集成到主流程，等待后续应用
  - [ ] 添加 `_deprecated/README.md`（说明弃用原因）

- [ ] **6.2** 更新文档
  - [ ] 更新 `README.md`
    - [ ] 更新架构说明
    - [ ] 更新功能列表
    - [ ] 更新安装步骤
  - [ ] 更新 `CLAUDE.md`
    - [ ] 更新项目状态（v4.0）
    - [ ] 更新检测方式说明
  - [ ] 更新 `AGENTS.md`
    - [ ] 更新代码地图
    - [ ] 更新架构说明
  - [ ] 创建 `CHANGELOG.md`
    - [ ] v4.0 重构说明
    - [ ] 破坏性变更说明

- [ ] **6.3** 更新配置和依赖
  - [ ] 更新 `config.json`（v4.0 配置）
  - [ ] 更新 `requirements.txt`
    - [ ] 添加 `watchdog>=3.0.0`
    - [ ] 移除不再需要的依赖
  - [ ] 更新 `pyproject.toml`（如果有）

- [ ] **6.4** 创建迁移指南
  - [ ] 创建 `docs/MIGRATION_v3_to_v4.md`
  - [ ] 说明变化内容
  - [ ] 提供迁移步骤
  - [ ] 列出破坏性变更

- [ ] **6.5** 最终测试
  - [ ] 全功能测试
  - [ ] 压力测试（长时间运行）
  - [ ] 跨平台测试（如果可能）
  - [ ] 文档完整性检查

---

## 可选增强功能（v4.1+）

### 跨平台支持
- [ ] macOS 路径适配（`~/.config/claude/`）
- [ ] Linux 路径适配

### 多 AI 工具支持
- [ ] OpenCode 日志监控
- [ ] Cursor 日志监控
- [ ] Codex 日志监控

### GUI 前端
- [ ] Electron 桌面应用
- [ ] 系统托盘图标
- [ ] 桌面宠物动画

### 高级功能
- [ ] 会话回放（历史记录可视化）
- [ ] Token 成本计算（价格 API）
- [ ] 统计图表（Token 趋势）
- [ ] 通知推送（关键事件）

---

## 检查清单

### 开发环境
- [ ] Python 3.9+
- [ ] 虚拟环境（venv）
- [ ] 依赖安装（`pip install -r requirements.txt`）
- [ ] Claude Code 已安装
- [ ] `~/.claude/projects/` 目录存在

### 测试环境
- [ ] Claude Code 运行中
- [ ] 有活跃会话
- [ ] JSONL 日志正在生成
- [ ] WebSocket 客户端（测试工具）
- [ ] HTTP 客户端（Postman/curl）

### 质量保证
- [ ] 代码格式化（black/ruff）
- [ ] 类型检查（mypy）
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] 性能测试通过
- [ ] 文档完整性检查

---

## 进度追踪

| 阶段 | 状态 | 完成度 | 预计时间 | 实际时间 |
|------|------|--------|----------|----------|
| 第一阶段 | 🔴 未开始 | 0% | 2-3 天 | - |
| 第二阶段 | 🔴 未开始 | 0% | 1-2 天 | - |
| 第三阶段 | 🔴 未开始 | 0% | 1 天 | - |
| **总计** | 🔴 未开始 | **0%** | **4-6 天** | **-** |

---

## 注意事项 ⚠️

1. **备份当前代码**
   - 在开始重构前，创建 `backup-v3.1` 分支
   - 或者直接 fork 仓库

2. **渐进式测试**
   - 每完成一个模块，立即测试
   - 不要等到全部完成再测试

3. **文档先行**
   - 更新文档和代码同步进行
   - 避免最后补文档

4. **保持沟通**
   - 遇到问题及时讨论
   - 不要自己卡住太久

---

**开始时间**: ___________  
**预计完成**: ___________  
**实际完成**: ___________

**状态图例**:
- 🔴 未开始
- 🟡 进行中
- 🟢 已完成
- ⚠️ 有问题
- ❌ 已放弃
